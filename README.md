# Сервис динамического сегментирования пользователей

## Технологии, которые были использованы:
- Postgresql
- Docker
- Docker-compose
- Swagger
- Gin

## Запуск и установка
Перед запуском в корневой папке создать .env файлы (env.example).

Для запуска в docker-compose выполнить:
```sh
docker-compose up --build
```


## Swagger

Swagger распологается по url: /docs/index.html

## Реализованый функционал

Примеры запросов находятся в файле test.postman_collection.json

Данные в базе данных о сегментах пользователей и автоматическом добавлении сегментов пользователей представлены в [scd 2](https://en.wikipedia.org/wiki/Slowly_changing_dimension). В качестве Default значения для столбца active\_from задается "9999-12-31 23:59:59" для более удобного сравнения с now(). При удалении сегмента у пользователя active\_from заменяется на now()

Описание endpoint'ов:
- /api/user (post) - Создание нового пользователя
- /api/user (get) - получение списка всех пользователей
- /api/segment (post) - создание нового сегмента. Пареметры: slug (обязательный) - название сегмента, percent (не обязательный) - при указании каждому пользователю с шансом 100/percent добавляется этот сегмент, timeToLive (не обязательный) - время (в секундах), которое будет добавляется этот сегмент новым (создаваемым) пользователям
- /api/user/{user_id}/segments (get) - получение активных сегментов пользователя
- /api/user/{user\_id}/segments (post) - добавление и удаление сегментов у пользователя. Параметры: appendSlugs (обязательный) - массив названий добавляемых сегментов пользователю (может быть пустым), deleteSlugs (обязательный) - массив названий удаляемых сегментов (может быть пустым), timeToLive - время жизни добавляемых сегментов (не обязательный), active\_from задается как now() + timeToLive секунд, 
- /api/user/{user_id}/report (get) - получение ссылки на csv отчет по пользователю за месяц. Параметры: month - месяц, year - год


*Доп. задание 1:*
Отчет формируется при get запросе на /api/user/{user_id}/report и возвращается ссылка на статический файл.

*Доп. задание 2:*
Для реализации добавлен параметр timeToLive в post /api/segment и модель построена в виде scd 2

*Доп. задание 3:*
Была добавлена новая таблица, хранящая долю попадания пользователей в сегмент, при добавлении применяется ко всем существующим пользователям и до active_from применяется ко всем новым пользователям, для этого также реализована в scd 2. Мною была выбрана реализация через рандом, так как id пользователей может быть не инкрементным , поэтому реализация корректного распределения по id была бы не возможна.
